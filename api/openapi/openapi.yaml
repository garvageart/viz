# yaml-language-server: $schema=https://spec.openapis.org/oas/3.0/schema/2021-09-28
openapi: 3.0.3
info:
  title: Imagine API
  version: 0.1.0
  description: OpenAPI specification for the Imagine API (chi-based)
servers:
  - url: http://localhost:7770
    description: Local API
paths:
  /ping:
    get:
      summary: Health ping
      operationId: ping
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                required: [message]

  /accounts/:
    post:
      summary: Register a new user
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/apikey:
    get:
      summary: Generate an API key
      operationId: generateApiKey
      responses:
        "200":
          description: API key generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/login:
    post:
      summary: Login with email and password
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
              required: [email, password]
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/oauth:
    get:
      summary: Initiate OAuth flow
      operationId: initiateOAuth
      parameters:
        - name: provider
          in: query
          required: true
          schema:
            type: string
            enum: [google, github]
          description: OAuth provider (google or github)
      responses:
        "307":
          description: Redirect to OAuth provider
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/oauth/{provider}:
    post:
      summary: Complete OAuth flow
      operationId: completeOAuth
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, github]
          description: OAuth provider (google or github)
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from OAuth provider
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        "200":
          description: OAuth successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OAuthUserData"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/session:
    get:
      summary: Get current session information
      operationId: getCurrentSession
      responses:
        "200":
          description: Current session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/logout:
    post:
      summary: Logout current session
      operationId: logout
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized (no active session)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/me:
    get:
      summary: Get current authenticated user
      operationId: getCurrentUser
      responses:
        "200":
          description: Authenticated user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images:
    get:
      summary: List all images with pagination
      operationId: listImages
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 25
          description: Number of images per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Page offset (0-based)
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImagesPage"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Upload an image (multipart)
      operationId: uploadImage
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                filename:
                  type: string
                data:
                  type: string
                  format: binary
              required: [filename, data]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete multiple asset UID directories (soft move to trash or force delete)
      operationId: deleteImagesBulk
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
                force:
                  type: boolean
              required: [uids]
      responses:
        "200":
          description: Deletion results (all succeeded)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteAssetsResponse"
        "207":
          description: Partial success (some failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteAssetsResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/url:
    post:
      summary: Upload an image by URL
      operationId: uploadImageByUrl
      requestBody:
        required: true
        content:
          text/plain:
            schema:
              type: string
              description: The URL of the image to fetch
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}/file:
    get:
      summary: Get a processed image file
      description: Retrieve an image, optionally transformed. Use download=1 with a token for authenticated downloads. Supports password protection and embed controls.
      operationId: getImageFile
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
        - in: query
          name: format
          schema:
            type: string
            enum: [webp, png, jpg, jpeg, avif, heif]
          description: Output format for transformation
        - in: query
          name: w
          schema:
            type: integer
            minimum: 0
          description: Width for transformation
        - in: query
          name: h
          schema:
            type: integer
            minimum: 0
          description: Height for transformation
        - in: query
          name: quality
          schema:
            type: integer
            minimum: 0
            maximum: 100
          description: Quality for transformation (0-100)
        - in: query
          name: download
          schema:
            type: string
            enum: ["1"]
          description: Set to "1" to force download mode (requires token)
        - in: query
          name: token
          schema:
            type: string
          description: Download token (required when download=1)
        - in: query
          name: password
          schema:
            type: string
          description: Password for password-protected tokens (optional)
      responses:
        "200":
          description: Image bytes
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Attachment header with filename
            ETag:
              schema:
                type: string
              description: Image checksum or transform signature
            Cache-Control:
              schema:
                type: string
              description: Caching directives
          content:
            image/*:
              schema:
                type: string
                format: binary
        "304":
          description: Not Modified (ETag match, only for non-download requests)
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized (invalid/expired token or incorrect password)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (downloads not allowed or embedding not permitted for this token)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}/download:
    get:
      summary: Create short-lived download token and redirect
      description: Creates a 5-minute download token and redirects to /images/{uid}/file?download=1&token=...
      operationId: quickDownloadImage
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
      responses:
        "302":
          description: Redirect to /images/{uid}/file with token
          headers:
            Location:
              schema:
                type: string
              description: Target URL with download=1 and token query params
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error (failed to create token)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections:
    get:
      summary: List collections
      operationId: listCollections
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Collections page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a collection
      operationId: createCollection
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CollectionCreate"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Collection"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections/{uid}:
    get:
      summary: Get collection detail
      operationId: getCollection
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Collection detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionDetailResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      summary: Update collection
      operationId: updateCollection
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CollectionUpdate"
      responses:
        "200":
          description: Collection updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Collection"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a collection
      operationId: deleteCollection
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content (collection deleted)
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections/{uid}/images:
    get:
      summary: List images in a collection
      operationId: listCollectionImages
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 100
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Images page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImagesPage"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Add images to a collection
      operationId: addCollectionImages
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
              required: [uids]
      responses:
        "200":
          description: Images added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
    delete:
      summary: Remove images from a collection
      operationId: deleteCollectionImages
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
              required: [uids]
      responses:
        "200":
          description: Images removed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /download:
    post:
      summary: Download a set of images as a ZIP (requires token)
      description: Download images using a token from /download/sign. Supports password-protected tokens and embed controls.
      operationId: downloadImages
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Download token from /download/sign (required)
        - in: query
          name: password
          required: false
          schema:
            type: string
          description: Password if the token is password-protected (optional)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DownloadRequest"
      responses:
        "200":
          description: ZIP archive
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized (invalid/expired token or incorrect password)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (downloads not allowed or embedding not permitted)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /download/sign:
    post:
      summary: Create a download token with optional access controls
      description: Generate a persistent download token for a set of images with configurable permissions and optional password protection
      operationId: signDownload
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignDownloadRequest"
      responses:
        "200":
          description: Download token created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadToken"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/healthcheck:
    post:
      summary: Admin-only healthcheck
      operationId: adminHealthcheck
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs:
    get:
      summary: List jobs
      operationId: listJobs
      responses:
        "200":
          description: Jobs list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create/enqueue a job
      operationId: createJob
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/JobCreateRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobEnqueueResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/{id}:
    get:
      summary: Get job detail
      operationId: getJob
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobInfo"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Cancel job
      operationId: cancelJob
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cancelled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Retry job
      operationId: retryJob
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
      responses:
        "501":
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/scheduler/start:
    post:
      summary: Start job scheduler
      operationId: startScheduler
      responses:
        "200":
          description: Started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/scheduler/shutdown:
    post:
      summary: Shutdown job scheduler
      operationId: shutdownScheduler
      responses:
        "200":
          description: Shutdown
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/enqueue-image-process:
    post:
      summary: Enqueue an image processing job (admin only)
      operationId: enqueueImageProcess
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EnqueueImageProcessRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/count:
    get:
      summary: Get running jobs count
      operationId: getJobsCount
      responses:
        "200":
          description: Running jobs count
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobCountResponse"

  /jobs/stats:
    get:
      summary: Get job stats by topic
      operationId: getJobStats
      responses:
        "200":
          description: Job stats (running and queued by topic)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JobStatsResponse"

  /jobs/types/{type}/stop:
    post:
      summary: Stop a job type
      operationId: stopJobType
      parameters:
        - in: path
          name: type
          required: true
          schema:
            type: string
          description: Job type to stop
      responses:
        "200":
          description: Job type stopped
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/types/{type}/concurrency:
    put:
      summary: Update job type concurrency
      operationId: updateJobTypeConcurrency
      parameters:
        - in: path
          name: type
          required: true
          schema:
            type: string
          description: Job type to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                concurrency:
                  type: integer
                  minimum: 1
                  maximum: 100
              required: [concurrency]
      responses:
        "200":
          description: Concurrency updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events:
    get:
      summary: WebSocket connection for real-time updates
      operationId: connectWebSocket
      description: |
        Opens a WebSocket connection for bidirectional real-time communication.

        **Protocol**: ws:// or wss://

        **Message Format**:
        ```json
        {
          "event": "event-type",
          "data": { ... },
          "id": 123,
          "timestamp": "2024-01-01T00:00:00Z"
        }
        ```

        **Event Types**:
        - `connected` - Connection established
        - `job-started` - Job has started
        - `job-progress` - Job progress update
        - `job-completed` - Job completed successfully
        - `job-failed` - Job failed with error
        - `ping` - Server keepalive (respond with pong)

      responses:
        "101":
          description: Switching Protocols - WebSocket connection established
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/stats:
    get:
      summary: Get WebSocket connection statistics
      operationId: getWSStats
      responses:
        "200":
          description: Connection statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSStatsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/metrics:
    get:
      summary: Get WebSocket event metrics
      operationId: getWSMetrics
      responses:
        "200":
          description: Event metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSMetricsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/history:
    get:
      summary: Get recent event history
      operationId: getEventHistory
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Maximum number of events to return
      responses:
        "200":
          description: Event history
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventHistoryResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Clear event history
      operationId: clearEventHistory
      responses:
        "200":
          description: History cleared
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/since:
    get:
      summary: Get events since a cursor ID
      operationId: getEventsSince
      description: |
        Retrieve events that occurred after a specific cursor ID.
        Useful for catching up on missed events during reconnection.
      parameters:
        - in: query
          name: cursor
          schema:
            type: integer
            format: uint64
            default: 0
          description: Cursor ID to fetch events after
        - in: query
          name: limit
          schema:
            type: integer
            default: 200
            maximum: 1000
          description: Maximum number of events to return
      responses:
        "200":
          description: Events since cursor
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: "#/components/schemas/EventRecord"
                  count:
                    type: integer
                  nextCursor:
                    type: integer
                    format: uint64
                required: [events, count, nextCursor]
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/broadcast:
    post:
      summary: Broadcast event to all connected WebSocket clients
      operationId: broadcastWSEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WSBroadcastRequest"
      responses:
        "200":
          description: Event broadcasted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSBroadcastResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/send/{clientId}:
    post:
      summary: Send event to specific WebSocket client
      operationId: sendToWSClient
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WSBroadcastRequest"
      responses:
        "200":
          description: Event sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  clientId:
                    type: string
                required: [success, message, clientId]
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    # Common response types
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]

    MessageResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]

    ImageUploadResponse:
      type: object
      properties:
        id:
          type: string
      required: [id]

    # Job-related schemas (used by admin endpoints)
    JobInfo:
      type: object
      properties:
        id:
          type: string
        topic:
          type: string
        status:
          type: string
      required: [id, topic, status]

    JobListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/JobInfo"
      required: [items]

    JobCreateRequest:
      type: object
      properties:
        type:
          type: string
          description: "Job type (e.g., thumbnailGeneration, imageProcessing)"
        command:
          type: string
          enum: [all, missing, single]
          description: "Command to execute (all=process all, missing=process missing, single=process one image)"
        image_uid:
          type: string
          description: "Image UID (required when command=single)"
      required: [type]

    JobEnqueueResponse:
      type: object
      properties:
        message:
          type: string
        count:
          type: integer
      required: [message]

    JobCountResponse:
      type: object
      properties:
        running:
          type: integer
      required: [running]

    JobStatsResponse:
      type: object
      properties:
        running:
          type: integer
        running_by_topic:
          type: object
          additionalProperties:
            type: integer
        queued_by_topic:
          type: object
          additionalProperties:
            type: integer
      required: [running, running_by_topic, queued_by_topic]

    EnqueueImageProcessRequest:
      type: object
      properties:
        image_uid:
          type: string
      required: [image_uid]

    # WebSocket-related schemas
    WSStatsResponse:
      type: object
      properties:
        connectedClients:
          type: integer
        clientIds:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time
      required: [connectedClients, clientIds, timestamp]

    WSMetricsResponse:
      type: object
      properties:
        connectedClients:
          type: integer
        totalEvents:
          type: integer
        eventsByType:
          type: object
          additionalProperties:
            type: integer
        timestamp:
          type: string
          format: date-time
      required: [connectedClients, totalEvents, eventsByType, timestamp]

    EventRecord:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        event:
          type: string
        data:
          type: object
          additionalProperties: true
      required: [timestamp, event, data]

    EventHistoryResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/EventRecord"
        count:
          type: integer
      required: [events, count]

    WSBroadcastRequest:
      type: object
      properties:
        event:
          type: string
        data:
          type: object
          additionalProperties: true
      required: [event, data]

    WSBroadcastResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        clients:
          type: integer
      required: [success, message, clients]

    AddImagesResponse:
      type: object
      properties:
        added:
          type: boolean
        error:
          type: string
      required: [added]

    DeleteImagesResponse:
      type: object
      properties:
        deleted:
          type: boolean
        error:
          type: string
      required: [deleted]

    DeleteAssetsResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              uid:
                type: string
              deleted:
                type: boolean
              error:
                type: string
            required: [uid, deleted]
        message:
          type: string
      required: [results]

    SignedExportResponse:
      type: object
      properties:
        url:
          type: string
        expires:
          type: integer
        sig:
          type: string
      required: [url, sig]

    DownloadRequest:
      type: object
      properties:
        uids:
          type: array
          items:
            type: string
        filename:
          type: string
      required: [uids]

    SignDownloadRequest:
      type: object
      description: Request to create a download token
      properties:
        uids:
          type: array
          items:
            type: string
          description: Array of image UIDs to include in the download token
        expires_in:
          type: integer
          description: Time in seconds until the token expires (0 for no expiry, default 900 = 15 minutes)
        allow_download:
          type: boolean
          description: Allow downloads using this token (default true)
          default: true
        allow_embed:
          type: boolean
          description: Allow embedding images on external sites (default false to prevent hotlinking)
          default: false
        show_metadata:
          type: boolean
          description: Include EXIF and other metadata in responses (default true)
          default: true
        password:
          type: string
          description: Optional password protection for the token (will be bcrypt hashed)
        description:
          type: string
          maxLength: 500
          description: Optional description of this share/download link

    DownloadToken:
      type: object
      description: Persistent download token with granular access controls
      properties:
        uid:
          type: string
          maxLength: 128
          description: 64-character hex token that serves as both unique identifier and authorization key
        image_uids:
          type: array
          items:
            type: string
          description: Array of authorized image UIDs
        allow_download:
          type: boolean
          description: Whether downloads are permitted with this token
          default: true
        allow_embed:
          type: boolean
          description: Whether embedding on external sites is allowed (false prevents hotlinking)
          default: false
        show_metadata:
          type: boolean
          description: Whether to include EXIF and metadata in responses
          default: true
        password:
          type: string
          nullable: true
          maxLength: 255
          description: Optional bcrypt hash of password (null if no password protection)
        description:
          type: string
          nullable: true
          maxLength: 500
          description: Optional description of this download link
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When this token expires (null for no expiry)
        created_at:
          type: string
          format: date-time
          description: When this token was created
        updated_at:
          type: string
          format: date-time
          description: When this token was last updated
      required:
        [
          uid,
          image_uids,
          allow_download,
          allow_embed,
          show_metadata,
          created_at,
          updated_at,
        ]

    APIKeyResponse:
      type: object
      properties:
        consumer_key:
          type: string
      required: [consumer_key]

    OAuthUserData:
      type: object
      properties:
        email:
          type: string
          format: email
        name:
          type: string
        picture:
          type: string
          format: uri
      required: [email, name, picture]

    Pagination:
      type: object
      properties:
        href:
          type: string
        prev:
          type: string
        next:
          type: string
        limit:
          type: integer
        offset:
          type: integer
        count:
          type: integer
      required: [href, limit, offset, count]

    ImageEXIF:
      type: object
      properties:
        exif_version: { type: string }
        make: { type: string }
        model: { type: string }
        date_time: { type: string }
        date_time_original: { type: string }
        iso: { type: string }
        focal_length: { type: string }
        exposure_time: { type: string }
        aperture: { type: string }
        flash: { type: string }
        white_balance: { type: string }
        lens_model: { type: string }
        modify_date: { type: string }
        rating: { type: string }
        orientation: { type: string }
        resolution: { type: string }
        software: { type: string }
        longitude: { type: string }
        latitude: { type: string }

    ImagePaths:
      type: object
      properties:
        original: { type: string }
        thumbnail: { type: string }
        preview: { type: string }
        raw: { type: string }
      required: [original, thumbnail, preview]

    ImageMetadata:
      type: object
      properties:
        file_name: { type: string }
        file_size: { type: integer, format: int64 }
        original_file_name: { type: string }
        file_type: { type: string }
        keywords:
          type: array
          items: { type: string }
        color_space: { type: string }
        file_modified_at: { type: string, format: date-time }
        file_created_at: { type: string, format: date-time }
        thumbhash: { type: string }
        label: { type: string }
        checksum: { type: string }
      required:
        [
          file_name,
          file_type,
          color_space,
          file_modified_at,
          file_created_at,
          checksum,
        ]

    Image:
      type: object
      properties:
        uid: { type: string }
        name: { type: string }
        uploaded_by:
          $ref: "#/components/schemas/User"
        description: { type: string }
        exif:
          $ref: "#/components/schemas/ImageEXIF"
        private: { type: boolean }
        width: { type: integer, format: int32 }
        height: { type: integer, format: int32 }
        processed: { type: boolean }
        image_metadata:
          $ref: "#/components/schemas/ImageMetadata"
        image_paths:
          $ref: "#/components/schemas/ImagePaths"
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [
          uid,
          name,
          private,
          width,
          height,
          processed,
          created_at,
          updated_at,
          image_paths,
        ]

    CollectionImage:
      type: object
      properties:
        uid: { type: string }
        added_at: { type: string, format: date-time }
        added_by:
          $ref: "#/components/schemas/User"
      required: [uid, added_at]

    Collection:
      type: object
      properties:
        uid: { type: string }
        name: { type: string }
        image_count: { type: integer }
        private: { type: boolean, nullable: true }
        images:
          type: array
          items:
            $ref: "#/components/schemas/CollectionImage"
        created_by:
          $ref: "#/components/schemas/User"
        description: { type: string }
        thumbnail:
          $ref: "#/components/schemas/Image"
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [uid, name, image_count, created_at, updated_at]

    CollectionCreate:
      type: object
      properties:
        name: { type: string }
        private: { type: boolean, nullable: true }
        description: { type: string }
      required: [name]

    CollectionUpdate:
      type: object
      properties:
        name: { type: string }
        thumbnailUID: { type: string }
        description: { type: string }
        private: { type: boolean }
        ownerUID: { type: string }

    ImagesResponse:
      type: object
      properties:
        added_at: { type: string, format: date-time }
        added_by:
          $ref: "#/components/schemas/User"
        image:
          $ref: "#/components/schemas/Image"
      required: [added_at, image]

    ImagesPage:
      type: object
      properties:
        href: { type: string }
        prev: { type: string }
        next: { type: string }
        limit: { type: integer }
        offset: { type: integer }
        count: { type: integer }
        items:
          type: array
          items:
            $ref: "#/components/schemas/ImagesResponse"
      required: [limit, offset, items]

    CollectionListResponse:
      type: object
      properties:
        href: { type: string }
        prev: { type: string }
        next: { type: string }
        limit: { type: integer }
        offset: { type: integer }
        count: { type: integer }
        items:
          type: array
          items:
            $ref: "#/components/schemas/Collection"
      required: [limit, offset, items]

    CollectionDetailResponse:
      type: object
      properties:
        uid: { type: string }
        name: { type: string }
        image_count: { type: integer }
        private: { type: boolean, nullable: true }
        images:
          $ref: "#/components/schemas/ImagesPage"
        created_by:
          $ref: "#/components/schemas/User"
        description: { type: string }
        thumbnail:
          $ref: "#/components/schemas/Image"
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [uid, name, images, created_at, updated_at]

    User:
      type: object
      properties:
        uid: { type: string }
        first_name: { type: string }
        last_name: { type: string }
        username: { type: string }
        email: { type: string }
        role:
          type: string
          enum: [user, admin, superadmin, guest]
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [
          uid,
          first_name,
          last_name,
          username,
          email,
          role,
          created_at,
          updated_at,
        ]

    UserCreate:
      type: object
      properties:
        name: { type: string }
        email: { type: string, format: email }
        password: { type: string }
      required: [name, email, password]
    Session:
      type: object
      properties:
        uid: { type: string }
        token: { type: string }
        user_uid: { type: string }
        user:
          $ref: "#/components/schemas/User"
        client_id: { type: string }
        client_name: { type: string }
        client_ip: { type: string }
        last_active: { type: string, format: date-time }
        expires_at: { type: string, format: date-time }
        timeout: { type: integer, format: int64 }
        user_agent: { type: string }
        ref_id: { type: string }
        login_ip: { type: string }
        login_at: { type: string, format: date-time }
        status: { type: integer }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [uid, token, user_uid, created_at, updated_at]
    APIKey:
      type: object
      properties:
        uid: { type: string }
        key_hashed: { type: string }
        user:
          $ref: "#/components/schemas/User"
        scopes:
          type: array
          items:
            type: string
        revoked: { type: boolean }
        revoked_at: { type: string, format: date-time }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [uid, key_hashed, created_at, updated_at]
