# yaml-language-server: $schema=https://spec.openapis.org/oas/3.0/schema/2021-09-28
openapi: 3.0.3
info:
  title: Viz API
  version: 0.1.0
  description: OpenAPI specification for the Viz API (chi-based)
servers:
  - url: http://{host}:{port}
    description: Local API
    variables:
      host:
        default: localhost
        description: Hostname or IP for the API server
      port:
        default: "7770"
        description: Port for the API server
  - url: /api
    description: Production API

security:
  - BearerAuth: []
  - CookieAuth: []

paths:
  /ping:
    get:
      summary: Health ping
      operationId: ping
      security: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    description: Pong message
                required: [message]

  /accounts/:
    post:
      summary: Register a new user
      operationId: registerUser
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserCreate"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (User Registration disabled, only admin's may register users)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/apikey:
    get:
      summary: Generate an API key
      operationId: generateApiKey
      security: []
      responses:
        "200":
          description: API key generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKey"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api-keys:
    post:
      summary: Create a new API key
      operationId: createApiKey
      security:
        - BearerAuth: [apikeys:write]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/APIKeyCreate"
      responses:
        "201":
          description: API key created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyCreateResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      summary: List API keys for the authenticated user
      operationId: listApiKeys
      security:
        - BearerAuth: [apikeys:read]
      responses:
        "200":
          description: List of API keys
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api-keys/{uid}:
    get:
      summary: Get API key details
      operationId: getApiKey
      security:
        - BearerAuth: [apikeys:read]
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: API key details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKey"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      summary: Delete an API key
      operationId: deleteApiKey
      security:
        - BearerAuth: [apikeys:write]
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api-keys/{uid}/revoke:
    post:
      summary: Revoke an API key
      operationId: revokeApiKey
      security:
        - BearerAuth: [apikeys:write]
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"

  /api-keys/{uid}/rotate:
    post:
      summary: Rotate an API key (revoke old, create new)
      operationId: rotateApiKey
      security:
        - BearerAuth: [apikeys:write]
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "201":
          description: New API key created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/APIKeyCreateResponse"

  /auth/login:
    post:
      summary: Login with email and password
      operationId: login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                  description: User email address
                password:
                  type: string
                  description: User password
              required: [email, password]
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/oauth:
    get:
      summary: Initiate OAuth flow
      operationId: initiateOAuth
      security: []
      parameters:
        - name: provider
          in: query
          required: true
          schema:
            type: string
            enum: [google, github]
          description: OAuth provider (google or github)
      responses:
        "307":
          description: Redirect to OAuth provider
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/oauth/{provider}:
    post:
      summary: Complete OAuth flow
      operationId: completeOAuth
      security: []
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, github]
          description: OAuth provider (google or github)
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from OAuth provider
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        "200":
          description: OAuth successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OAuthUserData"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/session:
    get:
      summary: Get current session information
      operationId: getCurrentSession
      security:
        - CookieAuth: []
      responses:
        "200":
          description: Current session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/logout:
    post:
      summary: Logout current session
      operationId: logout
      security:
        - CookieAuth: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized (no active session)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/me:
    get:
      summary: Get current authenticated user
      operationId: getCurrentUser
      security:
        - BearerAuth: []
        - CookieAuth: []
      responses:
        "200":
          description: Authenticated user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      summary: Update current authenticated user's profile
      operationId: updateCurrentUser
      security:
        - BearerAuth: []
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserUpdate"
      responses:
        "200":
          description: User profile updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found (implies authentication issue)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/me/onboard:
    put:
      summary: Onboard current authenticated user
      operationId: doUserOnboarding
      security:
        - BearerAuth: [user-onboard:update]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserOnboardingBody"
      responses:
        "200":
          description: User onboarded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request (e.g., validation error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found (implies authentication issue)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/me/password:
    put:
      summary: Update user password
      operationId: updatePassword
      security:
        - BearerAuth: []
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPasswordUpdate"
      responses:
        "200":
          description: Password updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserUpdate"
        "400":
          description: Bad request (missing fields)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized (incorrect current password)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /sessions:
    get:
      summary: Get all sessions for the current user
      operationId: getSessions
      security:
        - CookieAuth: []
      responses:
        "200":
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Session"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete all sessions for the current user
      operationId: deleteSessions
      security:
        - CookieAuth: []
      responses:
        "200":
          description: All sessions logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /sessions/{uid}:
    get:
      summary: Get a specific session by ID for the current user
      operationId: getSessionById
      security:
        - CookieAuth: []
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update a specific session
      operationId: updateSession
      security:
        - CookieAuth: []
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SessionUpdate"
      responses:
        "200":
          description: Session updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Session"
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a specific session
      operationId: deleteSession
      security:
        - CookieAuth: []
      parameters:
        - name: uid
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session revoked
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Session not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /accounts/me/settings:
    get:
      summary: Get all user settings
      description: Returns a merged list of settings (system defaults + user overrides).
      operationId: getUserSettings
      security:
        - BearerAuth: []
        - CookieAuth: []
      responses:
        "200":
          description: List of user settings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserSetting"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      summary: Update a user setting (Override)
      description: Creates or updates an override for a specific setting.
      operationId: updateUserSetting
      security:
        - BearerAuth: []
        - CookieAuth: []
      parameters:
        - in: query
          name: name
          required: true
          schema:
            type: string
          description: Setting name (e.g. 'theme', 'notifications_email')
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                value:
                  type: string
                  description: New setting value
              required: [value]
      responses:
        "200":
          description: Setting updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSetting"
        "400":
          description: Bad request (invalid value or not editable)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Setting not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update multiple user settings (batch override)
      description: Creates or updates overrides for multiple user-specific settings.
      operationId: updateUserSettingsBatch
      security:
        - BearerAuth: []
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserSettingUpdateRequest"
      responses:
        "200":
          description: Settings updated
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserSetting"
        "400":
          description: Bad request (invalid value or not editable for any setting)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /search:
    get:
      summary: Search for images and collections
      operationId: executeSearch
      security:
        - BearerAuth: [images:read, collections:read]
        - CookieAuth: []
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Search query string (e.g. "johannesburg rating:>=4")
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
          description: Max items per category
        - name: page
          in: query
          schema:
            type: integer
            default: 0
          description: Page number
      responses:
        "200":
          description: Search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchListResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images:
    get:
      summary: List all images with pagination
      operationId: listImages
      security:
        - BearerAuth: [images:read]
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
          description: Number of images per page
        - name: page
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Current page index (0-based) of images being fetched
        - name: sort_by
          in: query
          schema:
            type: string
            default: taken_at
            enum: [taken_at, created_at, updated_at, name]
            description: Key which images are sorted by
        - name: order
          in: query
          schema:
            type: string
            default: DESC
          description: Ascending or descending of the phots
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImagesListResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Upload an image (multipart)
      operationId: uploadImage
      security:
        - BearerAuth: [images:write]
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/ImageUploadRequest"
      responses:
        "200":
          description: Image already exists (duplicate)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete multiple asset UID directories (soft move to trash or force delete)
      operationId: deleteImagesBulk
      security:
        - BearerAuth: [images:write]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
                  description: List of image UIDs
                force:
                  type: boolean
                  description: Force deletion
              required: [uids]
      responses:
        "200":
          description: Deletion results (all succeeded)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteAssetsResponse"
        "207":
          description: Partial success (some failed)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteAssetsResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/url:
    post:
      summary: Upload an image by URL
      operationId: uploadImageByUrl
      security:
        - BearerAuth: [images:write]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          text/plain:
            schema:
              type: string
              description: The URL of the image to fetch
      responses:
        "200":
          description: Image already exists (duplicate)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageUploadResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}/file:
    get:
      summary: Get a processed image file
      description: Retrieve an image, optionally transformed. Use download=1 with a token for authenticated downloads. Supports password protection and embed controls.
      operationId: getImageFile
      security:
        - BearerAuth: [images:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
        - in: query
          name: format
          schema:
            type: string
            enum: [webp, png, jpg, jpeg, avif, heif]
          description: Output format for transformation
        - in: query
          name: width
          schema:
            type: integer
            minimum: 0
          description: Width for transformation
        - in: query
          name: height
          schema:
            type: integer
            minimum: 0
          description: Height for transformation
        - in: query
          name: quality
          schema:
            type: integer
            minimum: 0
            maximum: 100
          description: Quality for transformation (0-100)
        - in: query
          name: download
          schema:
            type: string
            enum: ["1"]
          description: Set to "1" to force download mode (requires token)
        - in: query
          name: token
          schema:
            type: string
          description: Download token (required when download=1)
        - in: query
          name: password
          schema:
            type: string
          description: Password for password-protected tokens (optional)
      responses:
        "200":
          description: Image bytes
          headers:
            Content-Disposition:
              schema:
                type: string
              description: Attachment header with file_name
            ETag:
              schema:
                type: string
              description: Image checksum or transform signature
            Cache-Control:
              schema:
                type: string
              description: Caching directives
          content:
            image/*:
              schema:
                type: string
                format: binary
        "304":
          description: Not Modified (ETag match, only for non-download requests)
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized (invalid/expired token or incorrect password)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (downloads not allowed or embedding not permitted for this token)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}/exif:
    get:
      summary: Get EXIF data for an image
      description: |
        Retrieve EXIF metadata for an image. If the query parameter `simple=true` is set
        the server will return the stored (simplified) `ImageEXIF` object from the database
        when available. Otherwise the server will re-read the file and return the full raw
        EXIF map extracted from the original file.
      operationId: getImageExif
      security:
        - BearerAuth: [images:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
        - in: query
          name: simple
          required: false
          schema:
            type: boolean
          description: When true, return the stored simplified EXIF object from the DB (otherwise read raw EXIF from file)
      responses:
        "200":
          description: EXIF data (simplified ImageEXIF when `simple=true`, raw EXIF map otherwise)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageEXIF"
            application/vnd.raw-exif+json:
              schema:
                type: object
                description: Raw EXIF key->value map extracted from the original file
                additionalProperties:
                  type: string
        "400":
          description: Bad request (invalid request body)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found (image missing)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error (failed to read or process image)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}:
    get:
      summary: Get image metadata
      operationId: getImage
      security:
        - BearerAuth: [images:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
      responses:
        "200":
          description: Image resource
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageAsset"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    patch:
      summary: Update image metadata
      operationId: updateImage
      security:
        - BearerAuth: [images:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ImageUpdate"
      responses:
        "200":
          description: Updated image resource
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImageAsset"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Image not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /images/{uid}/download:
    get:
      summary: Create short-lived download token and redirect
      description: Creates a 5-minute download token and redirects to /images/{uid}/file?download=1&token=...
      operationId: quickDownloadImage
      security:
        - BearerAuth: [images:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
          description: Image UID
      responses:
        "302":
          description: Redirect to /images/{uid}/file with token
          headers:
            Location:
              schema:
                type: string
              description: Target URL with download=1 and token query params
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error (failed to create token)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections:
    get:
      summary: List collections
      operationId: listCollections
      security:
        - BearerAuth: [collections:read]
        - CookieAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
        - in: query
          name: page
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Page index (0-based)
      responses:
        "200":
          description: Collections page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionListResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a collection
      operationId: createCollection
      security:
        - BearerAuth: [collections:write]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CollectionCreate"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Collection"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections/{uid}:
    get:
      summary: Get collection detail
      operationId: getCollection
      security:
        - BearerAuth: [collections:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Collection detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CollectionDetailResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      summary: Update collection
      operationId: updateCollection
      security:
        - BearerAuth: [collections:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CollectionUpdate"
      responses:
        "200":
          description: Collection updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Collection"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a collection
      operationId: deleteCollection
      security:
        - BearerAuth: [collections:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "204":
          description: No Content (collection deleted)
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /collections/{uid}/images:
    get:
      summary: List images in a collection
      operationId: listCollectionImages
      security:
        - BearerAuth: [collections:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            default: 100
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Images page
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImagesListResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Add images to a collection
      operationId: addCollectionImages
      security:
        - BearerAuth: [collections:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
                  description: List of image UIDs
              required: [uids]
      responses:
        "200":
          description: Images added
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddImagesResponse"
    delete:
      summary: Remove images from a collection
      operationId: deleteCollectionImages
      security:
        - BearerAuth: [collections:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                uids:
                  type: array
                  items:
                    type: string
                  description: List of image UIDs
              required: [uids]
      responses:
        "200":
          description: Images removed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteImagesResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /download:
    post:
      summary: Download a set of images as a ZIP (requires token)
      description: Download images using a token from /download/sign. Supports password-protected tokens and embed controls.
      operationId: downloadImages
      security:
        - BearerAuth: [downloads:create]
        - CookieAuth: []
      parameters:
        - in: query
          name: token
          required: true
          schema:
            type: string
          description: Download token from /download/sign (required)
        - in: query
          name: password
          required: false
          schema:
            type: string
          description: Password if the token is password-protected (optional)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DownloadRequest"
      responses:
        "200":
          description: ZIP archive
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized (invalid/expired token or incorrect password)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (downloads not allowed or embedding not permitted)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /download/sign:
    post:
      summary: Create a download token with optional access controls
      description: Generate a persistent download token for a set of images with configurable permissions and optional password protection
      operationId: signDownload
      security:
        - BearerAuth: [downloads:create]
        - CookieAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignDownloadRequest"
      responses:
        "200":
          description: Download token created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DownloadToken"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/settings/definitions:
    get:
      summary: List all setting definitions
      operationId: listSettingDefinitions
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: List of setting definitions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SettingDefault"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/settings/overrides:
    get:
      summary: List all overrides (debug/admin)
      operationId: listSettingOverrides
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: List of all overrides
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SettingOverride"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/healthcheck:
    post:
      summary: Admin-only healthcheck
      operationId: adminHealthcheck
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /system/config:
    get:
      summary: Get system configuration
      operationId: getSystemConfig
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: System configuration
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/VizConfig"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/system/stats:
    get:
      summary: Get system statistics (uptime, memory)
      operationId: getSystemStats
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: System stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemStatsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/db/stats:
    get:
      summary: Get database statistics (counts)
      operationId: getDatabaseStats
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: Database stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DatabaseStatsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/cache/status:
    get:
      summary: Get cache status
      operationId: getCacheStatus
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: Cache status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CacheStatusResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/cache:
    delete:
      summary: Clear the image cache
      operationId: clearImageCache
      security:
        - BearerAuth: [admin:write]
        - CookieAuth: []
      responses:
        "200":
          description: Cache cleared
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/users:
    get:
      summary: List all users
      operationId: listUsers
      security:
        - BearerAuth: [admin:read]
        - CookieAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a new user (admin)
      operationId: adminCreateUser
      security:
        - BearerAuth: [admin:write]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminUserCreate"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: User already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /admin/users/{uid}:
    patch:
      summary: Update user details (admin)
      operationId: adminUpdateUser
      security:
        - BearerAuth: [admin:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AdminUserUpdate"
      responses:
        "200":
          description: User updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete user (admin)
      operationId: adminDeleteUser
      security:
        - BearerAuth: [admin:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                force:
                  type: boolean
                  default: false
                  description: If true, permanently deletes the user and all associated data (sessions, settings).
      responses:
        "200":
          description: User deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/workers:
    get:
      summary: List all workers
      operationId: listAvailableWorkers
      security:
        - BearerAuth: [jobs:read]
        - CookieAuth: []
      responses:
        "200":
          description: Workers list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkersListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Register a new worker
      operationId: registerWorker
      security:
        - BearerAuth: [jobs:create]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkerRegisterRequest"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkerInfo"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs:
    post:
      summary: Create/enqueue a job
      operationId: createJob
      security:
        - BearerAuth: [jobs:create]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WorkerJobCreateRequest"
      responses:
        "202":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkerJobEnqueueResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    get:
      summary: List jobs with filtering and pagination
      operationId: listJobs
      security:
        - BearerAuth: [jobs:read]
        - CookieAuth: []
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [queued, running, completed, failed, cancelled]
          description: Filter by job status
        - in: query
          name: topic
          schema:
            type: string
          description: Filter by job topic
        - in: query
          name: limit
          schema:
            type: integer
            default: 25
          description: Number of jobs per page
        - in: query
          name: page
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Page index (0-based)
      responses:
        "200":
          description: Jobs list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkerJobsResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/{uid}:
    get:
      summary: Get job detail
      operationId: getJob
      security:
        - BearerAuth: [jobs:read]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Job detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkerJob"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Cancel job
      operationId: cancelJob
      security:
        - BearerAuth: [jobs:delete]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cancelled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Retry job
      operationId: retryJob
      security:
        - BearerAuth: [jobs:update]
        - CookieAuth: []
      parameters:
        - in: path
          name: uid
          required: true
          schema:
            type: string
      responses:
        "501":
          description: Not implemented
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /jobs/stats:
    get:
      summary: Get job stats by topic
      operationId: getJobStats
      security:
        - BearerAuth: [jobs:read]
        - CookieAuth: []
      responses:
        "200":
          description: Job stats (running and queued by topic)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkerJobStatsResponse"

  /events:
    get:
      summary: WebSocket connection for real-time updates
      operationId: connectWebSocket
      description: |
        Opens a WebSocket connection for bidirectional real-time communication.

        **Protocol**: ws:// or wss://

        **Message Format**:
        ```json
        {
          "event": "event-type",
          "data": { ... },
          "id": 123,
          "timestamp": "2024-01-01T00:00:00Z"
        }
        ```

        **Event Types**:
        - `connected` - Connection established
        - `job-started` - Job has started
        - `job-progress` - Job progress update
        - `job-completed` - Job completed successfully
        - `job-failed` - Job failed with error
        - `ping` - Server keepalive (respond with pong)

      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      responses:
        "101":
          description: Switching Protocols - WebSocket connection established
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/stats:
    get:
      summary: Get WebSocket connection statistics
      operationId: getWSStats
      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      responses:
        "200":
          description: Connection statistics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSStatsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/metrics:
    get:
      summary: Get WebSocket event metrics
      operationId: getWSMetrics
      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      responses:
        "200":
          description: Event metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSMetricsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/history:
    get:
      summary: Get recent event history
      operationId: getEventHistory
      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Maximum number of events to return
      responses:
        "200":
          description: Event history
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EventHistoryResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Clear event history
      operationId: clearEventHistory
      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      responses:
        "200":
          description: History cleared
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/since:
    get:
      summary: Get events since a cursor ID
      operationId: getEventsSince
      description: |
        Retrieve events that occurred after a specific cursor ID.
        Useful for catching up on missed events during reconnection.
      security:
        - BearerAuth: [events:read]
        - CookieAuth: []
      parameters:
        - in: query
          name: cursor
          schema:
            type: integer
            format: uint64
            default: 0
          description: Cursor ID to fetch events after
        - in: query
          name: limit
          schema:
            type: integer
            default: 200
            maximum: 1000
          description: Maximum number of events to return
      responses:
        "200":
          description: Events since cursor
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: "#/components/schemas/EventRecord"
                    description: List of events
                  count:
                    type: integer
                    description: Number of events
                  nextCursor:
                    type: integer
                    format: uint64
                    description: Next cursor ID
                required: [events, count, nextCursor]
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/broadcast:
    post:
      summary: Broadcast event to all connected WebSocket clients
      operationId: broadcastWSEvent
      security:
        - BearerAuth: [events:write]
        - CookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WSBroadcastRequest"
      responses:
        "200":
          description: Event broadcasted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WSBroadcastResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/send/{clientId}:
    post:
      summary: Send event to specific WebSocket client
      operationId: sendToWSClient
      security:
        - BearerAuth: [events:write]
        - CookieAuth: []
      parameters:
        - in: path
          name: clientId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/WSBroadcastRequest"
      responses:
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /system/status:
    get:
      summary: Get system and user onboarding status
      operationId: getSystemStatus
      security: [] # Public endpoint, no auth required to check initial status
      responses:
        "200":
          description: System status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemStatusResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /setup/superadmin:
    post:
      summary: Initialize application with first superadmin user
      operationId: setupSuperadmin
      security: [] # Public endpoint, no auth required for initial setup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SuperadminSetupRequest"
      responses:
        "201":
          description: Superadmin user created and setup complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuperadminSetupResponse"
        "400":
          description: Bad request (e.g., validation error, already initialized)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Conflict (system already initialized)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: "API key for authentication. The key should be provided in the Authorization header as a Bearer token. This token is a hex-encoded string of random bytes, prefixed with 'IMAG_'. Bearer format is intentionally omitted to avoid JWT confusion."
      x-scopes:
        admin:read: Read admin resources
        admin:write: Write admin resources
        api_keys:create: Create API keys
        api_keys:list: List API keys
        api_keys:get: Get API key details
        api_keys:revoke: Revoke API keys
        api_keys:rotate: Rotate API keys
        api_keys:delete: Delete API keys
        auth:refresh: Refresh authentication tokens
        auth:revoke: Revoke authentication tokens
        collections:create: Create collections
        collections:read: Read collections
        collections:update: Update collections
        collections:delete: Delete collections
        collections:share: Share collections
        images:read: Read images
        images:upload: Upload images
        images:update: Update images
        images:delete: Delete images
        images:download: Download images
        jobs:read: Read jobs
        jobs:create: Create jobs
        jobs:update: Update jobs
        jobs:delete: Delete jobs
        users:create: Create users
        users:read: Read users
        users:update: Update users
        users:delete: Delete users
        user_settings:read: Read user settings
        user_settings:update: Update user settings
        downloads:create: Create downloads
        events:read: Read events
        "*": Grants all permissions (superuser)

    CookieAuth:
      type: apiKey
      in: cookie
      name: viz-auth_token
      description: "Session authentication using a cookie named 'viz-auth_token'. The cookie value is a hex-encoded string of securely-generated random bytes."

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required: [error]

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          description: Response message
      required: [message]

    ImageUploadRequest:
      type: object
      properties:
        data:
          type: string
          format: binary
          description: Image file data
        file_name:
          type: string
          description: Name of the file
        checksum:
          type: string
          description: Optional checksum of the file
      required: [data, file_name]

    ImageUploadResponse:
      type: object
      properties:
        uid:
          type: string
          description: UID of the uploaded image
        metadata:
          type: object
          additionalProperties: true
          description: Extracted metadata
      required: [uid]

    AdminUserCreate:
      type: object
      properties:
        name:
          type: string
          description: User's full name
        email:
          type: string
          format: email
          description: User's email address
        password:
          type: string
          description: User's password
        role:
          type: string
          enum: [user, admin, superadmin, guest]
          default: user
          description: User role
      required: [name, email, password]

    SystemStatsResponse:
      type: object
      properties:
        uptime_seconds:
          type: integer
          format: int64
          description: System uptime in seconds
        num_goroutine:
          type: integer
          description: Number of running goroutines
        alloc_memory:
          type: integer
          format: int64
          description: "Bytes of allocated heap objects"
        sys_memory:
          type: integer
          format: int64
          description: "Total bytes of memory obtained from the OS"
        storage_used_bytes:
          type: integer
          format: int64
          description: "Total size of files in the base directory"
        storage_path:
          type: string
          description: Path to storage directory
        total_system_space_bytes:
          type: integer
          format: int64
          description: "Total disk space on the system"
        total_available_space_bytes:
          type: integer
          format: int64
          description: "Total available disk space on the system"
      required:
        [
          uptime_seconds,
          num_goroutine,
          alloc_memory,
          sys_memory,
          storage_used_bytes,
          storage_path,
          total_system_space_bytes,
          total_available_space_bytes,
        ]

    DatabaseStatsResponse:
      type: object
      properties:
        user_count:
          type: integer
          format: int64
          description: Total number of users
        image_count:
          type: integer
          format: int64
          description: Total number of images
        collection_count:
          type: integer
          format: int64
          description: Total number of collections
        db_size_bytes:
          type: integer
          format: int64
          description: "Size of the database in bytes (Postgres only)"
        active_connections:
          type: integer
          format: int64
          description: "Number of active connections (Postgres only)"
      required: [user_count, image_count, collection_count]

    WorkerRegisterRequest:
      type: object
      properties:
        name:
          type: string
          description: "Job topic/worker name (e.g., exif_process, image_process)"
        concurrency:
          type: integer
          description: "Number of concurrent jobs for this worker"
      required: [name]

    WorkerInfo:
      type: object
      properties:
        name:
          type: string
          description: "Job topic/worker name (e.g., exif_process, image_process)"
        display_name:
          type: string
          description: "Human-readable worker name"
        concurrency:
          type: integer
          description: "Number of concurrent jobs for this worker"
        count:
          type: integer
          description: "Number of active worker jobs with this name/topic"
      required: [name, display_name, concurrency]

    WorkersListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/WorkerInfo"
          description: List of workers
      required: [items]

    WorkerJobCreateRequest:
      type: object
      properties:
        type:
          type: string
          description: "Job topic (e.g., exif_process, image_process)"
        command:
          type: string
          enum: [all, missing]
          description: "Command to execute (all=process all, missing=process missing)"
        uids:
          type: array
          items:
            type: string
          description: "Image UIDs to process (optional, if omitted all images are considered)"
      required: [type, command]

    WorkerJobEnqueueResponse:
      type: object
      properties:
        message:
          type: string
          description: Response message
        count:
          type: integer
          description: Count of enqueued jobs
      required: [message]

    WorkerJob:
      x-entity: true
      type: object
      properties:
        uid:
          type: string
          description: Job UID
        type:
          type: string
          description: Job type
        topic:
          type: string
          description: Job topic
        command:
          type: string
          nullable: true
          description: Job command
        image_uid:
          type: string
          nullable: true
          description: Related image UID
        status:
          type: string
          description: Job status
        payload:
          type: string
          nullable: true
          description: Job payload
        error_code:
          type: string
          nullable: true
          description: Error code if failed
        error_msg:
          type: string
          nullable: true
          description: Error message if failed
        enqueued_at:
          type: string
          format: date-time
          description: Enqueued timestamp
        started_at:
          type: string
          format: date-time
          nullable: true
          description: Started timestamp
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: Completed timestamp
      required: [uid, type, topic, status, enqueued_at]

    WorkerJobsResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/WorkerJob"
          description: List of jobs
        total:
          type: integer
          description: Total count of jobs
      required: [items, total]

    WorkerJobStatsResponse:
      type: object
      properties:
        running:
          type: integer
          description: Total running jobs
        running_by_topic:
          type: object
          additionalProperties:
            type: integer
          description: Running jobs by topic
        queued_by_topic:
          type: object
          additionalProperties:
            type: integer
          description: Queued jobs by topic
      required: [running, running_by_topic, queued_by_topic]

    # WebSocket-related schemas
    WSStatsResponse:
      type: object
      properties:
        connectedClients:
          type: integer
          description: Number of connected clients
        clientIds:
          type: array
          items:
            type: string
          description: List of connected client IDs
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the stats
      required: [connectedClients, clientIds, timestamp]

    WSMetricsResponse:
      type: object
      properties:
        connectedClients:
          type: integer
          description: Number of connected clients
        totalEvents:
          type: integer
          description: Total events processed
        eventsByType:
          type: object
          additionalProperties:
            type: integer
          description: Count of events by type
        timestamp:
          type: string
          format: date-time
          description: Timestamp of the metrics
      required: [connectedClients, totalEvents, eventsByType, timestamp]

    EventRecord:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
        event:
          type: string
          description: Event name
        data:
          type: object
          additionalProperties: true
          description: Event data payload
      required: [timestamp, event, data]

    EventHistoryResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/EventRecord"
          description: List of historical events
        count:
          type: integer
          description: Count of events returned
      required: [events, count]

    WSBroadcastRequest:
      type: object
      properties:
        event:
          type: string
          description: Event name to broadcast
        data:
          type: object
          additionalProperties: true
          description: Event data payload
      required: [event, data]

    WSBroadcastResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether broadcast was successful
        message:
          type: string
          description: Response message
        clients:
          type: integer
          description: Number of clients reached
      required: [success, message, clients]

    AddImagesResponse:
      type: object
      properties:
        added:
          type: boolean
          description: Whether images were added
        error:
          type: string
          description: Error message if failed
      required: [added]

    DeleteImagesResponse:
      type: object
      properties:
        deleted:
          type: boolean
          description: Whether images were deleted
        error:
          type: string
          description: Error message if failed
      required: [deleted]

    DeleteAssetsResponse:
      type: object
      properties:
        results:
          type: array
          items:
            type: object
            properties:
              uid:
                type: string
                description: UID of the asset
              deleted:
                type: boolean
                description: Whether it was deleted
              error:
                type: string
                description: Error message if failed
          description: Results of deletion
    SettingDefault:
      x-entity: true
      x-go-gorm-index:
        - name: idx_setting_defaults_name
          unique: true
          fields: [name]
      type: object
      description: Defines a setting available in the system.
      properties:
        name:
          type: string
          description: Unique name for the setting (primary key).
        display_name:
          type: string
          description: A readable and UI-friendly name for the setting (not required but highly recommended).
        value:
          type: string
          description: The default value everyone gets.
        value_type:
          type: string
          enum: [boolean, string, integer, enum, json]
          description: Data type of the setting.
        allowed_values:
          type: array
          items:
            type: string
          nullable: true
          description: List of valid choices if type is enum.
        is_user_editable:
          type: boolean
          description: Describes whether a user can edit this setting.
        group:
          type: string
          description: Category/group for the setting (e.g., General, Notifications).
        description:
          type: string
          description: Description for UI
      required:
        [
          name,
          display_name,
          value,
          value_type,
          is_user_editable,
          group,
          description,
        ]

    SettingOverride:
      x-entity: true
      x-go-gorm-index:
        - name: idx_setting_overrides_user_name
          unique: true
          fields: [user_id, name]
      type: object
      description: Stores user-specific changes to settings.
      properties:
        user_id:
          type: string
          description: Links to the users table.
        name:
          type: string
          description: Links to SettingDefault.name.
        value:
          type: string
          description: The user's chosen value for the setting.
      required: [user_id, name, value]

    UserSetting:
      type: object
      description: The effective setting for a user (merged Default and Override).
      properties:
        name:
          type: string
          description: Setting unique name
        display_name:
          type: string
          description: Readable name
        value:
          type: string
          description: The effective value (override if exists, else default).
        default_value:
          type: string
          description: Default value
        value_type:
          type: string
          description: Type of the value
        allowed_values:
          type: array
          items:
            type: string
          nullable: true
          description: Allowed values if enum
        is_user_editable:
          type: boolean
          description: Whether user can edit
        group:
          type: string
          description: Setting group
        description:
          type: string
          description: Setting description
      required:
        [
          name,
          display_name,
          value,
          default_value,
          value_type,
          group,
          description,
        ]

    SignedExportResponse:
      type: object
      properties:
        url:
          type: string
          description: Download URL
        expires:
          type: integer
          description: Expiry timestamp
        sig:
          type: string
          description: Signature
      required: [url, sig]

    DownloadRequest:
      type: object
      properties:
        uids:
          type: array
          items:
            type: string
          description: List of UIDs to download
        file_name:
          type: string
          description: Desired filename for the archive
      required: [uids]

    SignDownloadRequest:
      type: object
      description: Request to create a download token
      properties:
        uids:
          type: array
          items:
            type: string
          description: Array of image UIDs to include in the download token
        expires_in:
          type: integer
          description: Time in seconds until the token expires (0 for no expiry, default 900 = 15 minutes)
        allow_download:
          type: boolean
          description: Allow downloads using this token (default true)
          default: true
        allow_embed:
          type: boolean
          description: Allow embedding images on external sites (default false to prevent hotlinking)
          default: false
        show_metadata:
          type: boolean
          description: Include EXIF and other metadata in responses (default true)
          default: true
        password:
          type: string
          description: Optional password protection for the token (will be bcrypt hashed)
        description:
          type: string
          maxLength: 500
          description: Optional description of this share/download link

    DownloadToken:
      x-entity: true
      type: object
      description: Persistent download token with granular access controls
      properties:
        uid:
          type: string
          maxLength: 128
          description: 64-character hex token that serves as both unique identifier and authorization key
        image_uids:
          type: array
          items:
            type: string
          description: Array of authorized image UIDs
        allow_download:
          type: boolean
          description: Whether downloads are permitted with this token
          default: true
        allow_embed:
          type: boolean
          description: Whether embedding on external sites is allowed (false prevents hotlinking)
          default: false
        show_metadata:
          type: boolean
          description: Whether to include EXIF and metadata in responses
          default: true
        password:
          type: string
          nullable: true
          maxLength: 255
          description: Optional bcrypt hash of password (null if no password protection)
        description:
          type: string
          nullable: true
          maxLength: 500
          description: Optional description of this download link
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: When this token expires (null for no expiry)
        created_at:
          type: string
          format: date-time
          description: When this token was created
        updated_at:
          type: string
          format: date-time
          description: When this token was last updated
      required:
        [
          uid,
          image_uids,
          allow_download,
          allow_embed,
          show_metadata,
          created_at,
          updated_at,
        ]

    CacheStatusResponse:
      type: object
      properties:
        size:
          type: integer
          description: Current size of the cache in bytes
        items:
          type: integer
          description: Number of items currently in the cache
        hits:
          type: integer
          description: Number of cache hits
        misses:
          type: integer
          description: Number of cache misses
        hit_ratio:
          type: number
          format: float
          description: Cache hit ratio
      required: [size, items, hits, misses, hit_ratio]

    OAuthUserData:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User email
        name:
          type: string
          description: User name
        picture:
          type: string
          format: uri
          description: User profile picture URL
      required: [email, name, picture]

    Pagination:
      type: object
      properties:
        href:
          type: string
          description: Self link
        prev:
          type: string
          description: Previous page link
        next: { type: string, description: Next page link }
        limit: { type: integer, description: Limit per page }
        offset: { type: integer, description: Offset }
        count: { type: integer, description: Total count }
      required: [href, limit, offset, count]

    ImageEXIF:
      type: object
      properties:
        exif_version: { type: string, description: EXIF version }
        make: { type: string, description: Camera make }
        model: { type: string, description: Camera model }
        date_time: { type: string, description: Date and time }
        date_time_original:
          { type: string, description: Original date and time }
        iso: { type: string, description: ISO speed rating }
        focal_length: { type: string, description: Focal length }
        exposure_time: { type: string, description: Exposure time }
        aperture: { type: string, description: Aperture }
        exposure_value: { type: string, description: Exposure value }
        f_number: { type: string, description: F-number }
        flash: { type: integer, description: Flash fired }
        white_balance: { type: string, description: White balance }
        lens_make: { type: string, description: Lens make }
        lens_model: { type: string, description: Lens model }
        focal_length_in_35mm_format:
          { type: string, description: Focal length in 35mm format }
        scene_capture_type: { type: string, description: Scene capture type }
        exposure_program: { type: string, description: Exposure program }
        metering_mode: { type: string, description: Metering mode }
        sensing_method: { type: string, description: Sensing method }
        light_source: { type: string, description: Light source }
        exposure_bias_value: { type: string, description: Exposure bias value }
        max_aperture_value: { type: string, description: Max aperture value }
        exposure_mode: { type: string, description: Exposure mode }
        digital_zoom_ratio: { type: string, description: Digital zoom ratio }
        focal_plane_x_resolution:
          { type: string, description: Focal plane X resolution }
        focal_plane_y_resolution:
          { type: string, description: Focal plane Y resolution }
        focal_plane_resolution_unit:
          { type: string, description: Focal plane resolution unit }
        copyright: { type: string, description: Copyright }
        modify_date: { type: string, description: Modify date }
        rating: { type: string, description: Rating }
        orientation: { type: string, description: Orientation }
        resolution: { type: string, description: Resolution }
        software: { type: string, description: Software }
        longitude: { type: string, description: GPS Longitude }
        latitude: { type: string, description: GPS Latitude }
        gps_altitude: { type: string, description: GPS Altitude }
        gps_img_direction: { type: string, description: GPS Image Direction }
        gps_img_direction_ref:
          { type: string, description: GPS Image Direction Ref }
        gps_speed: { type: string, description: GPS Speed }
        gps_speed_ref: { type: string, description: GPS Speed Ref }
        offset_time: { type: string, description: Offset time }
        offset_time_original:
          { type: string, description: Offset time original }
        offset_time_digitized:
          { type: string, description: Offset time digitized }

    ImagePaths:
      type: object
      properties:
        original: { type: string, description: Path to original file }
        thumbnail: { type: string, description: Path to thumbnail }
        preview: { type: string, description: Path to preview }
        raw: { type: string, description: Path to raw file }
      required: [original, thumbnail, preview]

    ImageMetadata:
      type: object
      properties:
        file_name: { type: string, description: Original file name }
        file_size:
          { type: integer, format: int64, description: File size in bytes }
        original_file_name: { type: string, description: Original file name }
        file_type: { type: string, description: File MIME type }
        metadata: { type: string, description: Additional metadata }
        rating:
          {
            type: integer,
            minimum: 0,
            maximum: 5,
            nullable: true,
            description: "User-assigned rating (0-5). Null = unrated",
          }
        keywords:
          type: array
          items: { type: string }
          description: Keywords
        color_space: { type: string, description: Color space }
        has_icc_profile: { type: boolean, description: Has ICC profile }
        file_modified_at:
          {
            type: string,
            format: date-time,
            description: File modification time,
          }
        file_created_at:
          { type: string, format: date-time, description: File creation time }
        thumbhash: { type: string, description: Thumbhash }
        label:
          type: string
          enum: [Red, Orange, Yellow, Purple, Pink, Green, Blue, None]
          nullable: true
          description: "User-assigned label for the image. Null = unlabeled"

        checksum: { type: string, description: File checksum }
      required:
        [
          file_name,
          file_type,
          color_space,
          file_modified_at,
          file_created_at,
          checksum,
        ]

    ImageAsset:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: Image UID }
        name: { type: string, description: Image name }
        uploaded_by:
          $ref: "#/components/schemas/User"
        owner:
          $ref: "#/components/schemas/User"
        description: { type: string, description: Image description }
        exif:
          $ref: "#/components/schemas/ImageEXIF"
        private: { type: boolean, description: Is private }
        favourited: { type: boolean, description: Is favourited }
        width: { type: integer, format: int32, description: Image width }
        height: { type: integer, format: int32, description: Image height }
        processed: { type: boolean, description: Is processed }
        image_metadata:
          $ref: "#/components/schemas/ImageMetadata"
        image_paths:
          $ref: "#/components/schemas/ImagePaths"
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
        taken_at:
          {
            type: string,
            format: date-time,
            nullable: true,
            description: Taken time,
          }
      required:
        [
          uid,
          name,
          private,
          width,
          height,
          processed,
          created_at,
          updated_at,
          image_paths,
        ]

    CollectionImage:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: Image UID }
        added_at:
          { type: string, format: date-time, description: Added timestamp }
        added_by:
          $ref: "#/components/schemas/User"
      required: [uid, added_at]

    Collection:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: Collection UID }
        name: { type: string, description: Collection name }
        image_count: { type: integer, description: Number of images }
        private: { type: boolean, nullable: true, description: Is private }
        favourited: { type: boolean, description: Is favourited }
        images:
          type: array
          items:
            $ref: "#/components/schemas/CollectionImage"
          description: List of images
        created_by:
          $ref: "#/components/schemas/User"
        owner:
          $ref: "#/components/schemas/User"
        description: { type: string, description: Collection description }
        thumbnail:
          $ref: "#/components/schemas/ImageAsset"
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
      required: [uid, name, image_count, created_at, updated_at]

    CollectionCreate:
      type: object
      properties:
        name: { type: string, description: Collection name }
        private: { type: boolean, nullable: true, description: Is private }
        description: { type: string, description: Collection description }
      required: [name]

    CollectionUpdate:
      type: object
      properties:
        name: { type: string, description: Collection name }
        thumbnailUID: { type: string, description: Thumbnail image UID }
        description: { type: string, description: Collection description }
        private: { type: boolean, description: Is private }
        favourited: { type: boolean, description: Is favourited }
        ownerUID: { type: string, description: Owner UID }

    ImagesResponse:
      type: object
      properties:
        added_at:
          { type: string, format: date-time, description: Added timestamp }
        added_by:
          $ref: "#/components/schemas/User"
        image:
          $ref: "#/components/schemas/ImageAsset"
      required: [added_at, image]

    ImagesListResponse:
      type: object
      properties:
        href: { type: string, description: Self link }
        prev: { type: string, description: Previous page link }
        next: { type: string, description: Next page link }
        limit: { type: integer, description: Items per page }
        page: { type: integer, description: Current page }
        count: { type: integer, description: Total count }
        items:
          type: array
          items:
            $ref: "#/components/schemas/ImagesResponse"
          description: List of items
      required: [limit, page, items]

    CollectionListResponse:
      type: object
      properties:
        href: { type: string, description: Self link }
        prev: { type: string, description: Previous page link }
        next: { type: string, description: Next page link }
        limit: { type: integer, description: Items per page }
        page: { type: integer, description: Current page }
        count: { type: integer, description: Total count }
        items:
          type: array
          items:
            $ref: "#/components/schemas/Collection"
          description: List of collections
      required: [limit, page, items]

    CollectionDetailResponse:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: Collection UID }
        name: { type: string, description: Collection name }
        image_count: { type: integer, description: Number of images }
        private: { type: boolean, nullable: true, description: Is private }
        images:
          $ref: "#/components/schemas/ImagesListResponse"
        created_by:
          $ref: "#/components/schemas/User"
        owner:
          $ref: "#/components/schemas/User"
        description: { type: string, description: Collection description }
        thumbnail:
          $ref: "#/components/schemas/ImageAsset"
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
      required: [uid, name, images, created_at, updated_at]

    User:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: User UID }
        first_name: { type: string, description: First name }
        last_name: { type: string, description: Last name }
        username: { type: string, description: Username }
        email: { type: string, description: Email }
        role:
          type: string
          enum: [user, admin, superadmin, guest]
          description: User role
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
      required:
        [
          uid,
          first_name,
          last_name,
          username,
          email,
          role,
          created_at,
          updated_at,
        ]

    UserCreate:
      type: object
      properties:
        name: { type: string, description: Full name }
        email: { type: string, format: email, description: Email address }
        password: { type: string, description: Password }
      required: [name, email, password]

    UserUpdate:
      type: object
      properties:
        first_name:
          type: string
          nullable: true
          description: First name
        last_name:
          type: string
          nullable: true
          description: Last name
        username:
          type: string
          nullable: true
          description: Username
        email:
          type: string
          format: email
          nullable: true
          description: Email address

    AdminUserUpdate:
      type: object
      properties:
        first_name:
          type: string
          nullable: true
          description: First name
        last_name:
          type: string
          nullable: true
          description: Last name
        username:
          type: string
          nullable: true
          description: Username
        email:
          type: string
          format: email
          nullable: true
          description: Email address
        role:
          type: string
          enum: [user, admin, superadmin, guest]
          nullable: true
          description: User role

    UserPasswordUpdate:
      type: object
      properties:
        current:
          type: string
          description: Current password
        new:
          type: string
          description: New password
      required: [current, new]

    Session:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: Session UID }
        token: { type: string, description: Session token }
        user_uid: { type: string, description: User UID }
        user:
          $ref: "#/components/schemas/User"
        client_id: { type: string, description: Client ID }
        client_name: { type: string, description: Client name }
        client_ip: { type: string, description: Client IP }
        last_active:
          { type: string, format: date-time, description: Last active time }
        expires_at:
          { type: string, format: date-time, description: Expiry time }
        timeout:
          { type: integer, format: int64, description: Timeout in seconds }
        user_agent: { type: string, description: User agent }
        ref_id: { type: string, description: Reference ID }
        login_ip: { type: string, description: Login IP }
        login_at: { type: string, format: date-time, description: Login time }
        status: { type: integer, description: Session status }
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
      required: [uid, token, user_uid, created_at, updated_at]
    SessionUpdate:
      type: object
      properties:
        clientName:
          type: string
          nullable: true
          description: New client name
        status:
          type: integer
          nullable: true
          description: New status
    APIKey:
      x-entity: true
      type: object
      properties:
        uid: { type: string, description: API Key UID }
        name: { type: string, description: API Key name }
        description:
          { type: string, nullable: true, description: API Key description }
        key_hashed: { type: string, description: Hashed key }
        user:
          $ref: "#/components/schemas/User"
        scopes:
          type: array
          items:
            type: string
          description: List of scopes
        last_used_at:
          {
            type: string,
            format: date-time,
            nullable: true,
            description: Last used time,
          }
        revoked: { type: boolean, description: Is revoked }
        revoked_at:
          { type: string, format: date-time, description: Revocation time }
        expires_at:
          {
            type: string,
            format: date-time,
            nullable: true,
            description: Expiry time,
          }
        created_at:
          { type: string, format: date-time, description: Creation time }
        updated_at:
          { type: string, format: date-time, description: Update time }
      required: [uid, revoked, key_hashed, created_at, updated_at, scopes]

    APIKeyCreate:
      type: object
      properties:
        name:
          type: string
          description: API Key name
        description:
          type: string
          nullable: true
          description: API Key description
        scopes:
          type: array
          items:
            type: string
          description: List of scopes
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Expiry time

    APIKeyCreateResponse:
      type: object
      properties:
        consumer_key:
          type: string
          description: The consumer key (secret)
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Expiry time
      required: [consumer_key]

    APIKeyListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/APIKey"
          description: List of API keys
        count:
          type: integer
          description: Total count
      required: [items, count]

    SystemStatusResponse:
      type: object
      properties:
        initialized:
          type: boolean
          description: True if the system has been initialized (at least one superadmin exists and first_run_complete is true).
        user_onboarding_required:
          type: boolean
          description: True if the current user (if authenticated) still needs to complete onboarding.
        needs_superadmin:
          type: boolean
          description: True if the system requires initial superadmin setup (no superadmin exists).
        allow_manual_registration:
          type: boolean
          description: True if user registration is enabled, let's users register accounts themselves
      required:
        - initialized
        - user_onboarding_required
        - needs_superadmin
        - allow_manual_registration

    SuperadminSetupRequest:
      type: object
      properties:
        username:
          type: string
          description: Desired username
        email:
          type: string
          format: email
          description: Email address
        password:
          type: string
          description: Password
        firstName:
          type: string
          nullable: true
          description: First name
        lastName:
          type: string
          nullable: true
          description: Last name
      required:
        - username
        - email
        - password
    SuperadminSetupResponse:
      type: object
      properties:
        message:
          type: string
          description: Response message
        user:
          $ref: "#/components/schemas/User"
        sessionToken:
          type: string
          description: Session token for the newly created superadmin
      required:
        - message
        - user
        - sessionToken

    UserSettingUpdateRequest:
      type: object
      properties:
        settings:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                description: Setting name
              value:
                type: string
                description: Setting value
            required:
              - name
              - value
          description: List of settings to update
      required:
        - settings

    UserOnboardingBody:
      type: object
      properties:
        first_name:
          type: string
          description: First name
        last_name:
          type: string
          description: Last name
        settings:
          type: array
          description: User-specific setting overrides
          items:
            $ref: "#/components/schemas/UserSetting"
      required: [first_name, last_name, settings]

    ImageUpdate:
      type: object
      properties:
        name:
          type: string
          description: Image name
        owner_uid:
          type: string
          nullable: true
          description: Owner UID
        description:
          type: string
          nullable: true
          description: Image description
        private:
          type: boolean
          description: Is private
        favourited:
          type: boolean
          description: Is favourited
        exif:
          $ref: "#/components/schemas/ImageEXIF"
        image_metadata:
          type: object
          properties:
            label:
              type: string
              enum: [Red, Orange, Yellow, Purple, Pink, Green, Blue, None]
              nullable: true
              description: "User-assigned label for the image. Null = unlabeled"
            rating:
              type: integer
              minimum: 0
              maximum: 5
              nullable: true
              description: "User-assigned rating (0-5). Null = unrated"
            keywords:
              type: array
              items:
                type: string
              description: Keywords

    VizConfig:
      type: object
      properties:
        baseUrl:
          type: string
          description: Base URL of the application
        logging:
          $ref: "#/components/schemas/LoggingConfig"
        base_directory:
          type: string
          description: Base directory path
        upload:
          $ref: "#/components/schemas/UploadConfig"
        database:
          $ref: "#/components/schemas/DatabaseConfig"
        redis:
          $ref: "#/components/schemas/QueueConfig"
        libvips:
          $ref: "#/components/schemas/LibvipsConfig"
        cache:
          $ref: "#/components/schemas/CacheConfig"
        user_management:
          $ref: "#/components/schemas/UserManagementConfig"
        storage_metrics:
          $ref: "#/components/schemas/StorageMetricsConfig"

    LoggingConfig:
      type: object
      properties:
        level:
          type: string
          description: Logging level

    UploadConfig:
      type: object
      properties:
        location:
          type: string
          description: Upload location

    DatabaseConfig:
      type: object
      properties:
        location:
          type: string
          description: Database location/host
        user:
          type: string
          description: Database user
        password:
          type: string
          description: "Masked password"
        name:
          type: string
          description: Database name
        port:
          type: integer
          description: Database port

    QueueConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: Is queue enabled
        host:
          type: string
          description: Queue host
        port:
          type: integer
          description: Queue port
        username:
          type: string
          description: Queue username
        password:
          type: string
          description: "Masked password"
        db:
          type: integer
          description: Redis DB index
        use_tls:
          type: boolean
          description: Use TLS
        pool_size:
          type: integer
          description: Connection pool size
        dial_timeout_seconds:
          type: integer
          description: Dial timeout
        read_timeout_seconds:
          type: integer
          description: Read timeout
        write_timeout_seconds:
          type: integer
          description: Write timeout

    LibvipsConfig:
      type: object
      properties:
        match_system_logging:
          type: boolean
          description: Match system logging level
        cache_max_memory_mb:
          type: integer
          description: Cache max memory MB
        cache_max_files:
          type: integer
          description: Cache max files
        cache_max_operations:
          type: integer
          description: Cache max operations
        concurrency:
          type: integer
          description: Concurrency level
        vector_enabled:
          type: boolean
          description: Vector enabled

    CacheConfig:
      type: object
      properties:
        gc_enabled:
          type: boolean
          description: GC enabled

    UserManagementConfig:
      type: object
      properties:
        allow_manual_registration:
          type: boolean
          description: Allow manual registration

    StorageMetricsConfig:
      type: object
      properties:
        enabled:
          type: boolean
          description: Metrics enabled
        interval_seconds:
          type: integer
          description: Interval in seconds

    SearchListResponse:
      type: object
      properties:
        images:
          type: array
          items:
            $ref: "#/components/schemas/ImageAsset"
          description: List of images found
        collections:
          type: array
          items:
            $ref: "#/components/schemas/Collection"
          description: List of collections found
      required: [images, collections]
