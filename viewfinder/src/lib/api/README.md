# API Client

Type-safe API client auto-generated from OpenAPI specification using **`oazapfts`**.

**Features:**
- **Fully generated**: Types AND functions auto-generated from OpenAPI spec
- **Type-safe**: Complete TypeScript support with inference
- **Simple**: Clean function signatures, no manual path construction
- **SvelteKit native**: Uses global fetch (enhanced automatically in SSR)

## Overview

This directory contains:
- **`client.gen.ts`**: Auto-generated by oazapfts (DO NOT EDIT)
- **`client.ts`**: Configures base URL and exports all functions
- **`functions.custom.ts`**: Custom functions for special cases (e.g., upload progress)
- **`index.ts`**: Re-exports everything for convenient imports

## Usage

### Generated Functions

All API endpoints are available as simple, typed functions:

```typescript
import { listCollections, createCollection, addCollectionImages } from "$lib/api";

// List collections with pagination
const response = await listCollections({ limit: 50, offset: 0 });
console.log(response.data.items); // Fully typed!

// Create a collection
const newCollection = await createCollection({
  name: "My Collection",
  description: "A great collection",
  private: true
});

// Add images to collection
await addCollectionImages("collection-uid", {
  uids: ["img1", "img2", "img3"]
});
```

### Response Format

All functions return `{ status, data }`:

```typescript
const response = await listCollections({});

// response.status: HTTP status code (200, 201, etc.)
// response.data: Fully typed response data

console.log(response.status); // 200
console.log(response.data.items); // Collection[]
```

### SvelteKit Integration

Functions automatically work in both server and client contexts:

```typescript
// +page.server.ts
import { listCollections } from "$lib/api";
import type { PageServerLoad } from "./$types";

export const load: PageServerLoad = async () => {
  // Uses SvelteKit's enhanced fetch automatically
  const response = await listCollections({});
  return { collections: response.data.items };
};
```

## Benefits

✅ **Auto-generated**: Types AND functions from OpenAPI spec  
✅ **Type-safe**: Full TypeScript inference throughout  
✅ **Clean API**: Simple function calls, no manual URLs  
✅ **SvelteKit native**: Works seamlessly with SSR  
✅ **No manual work**: Add endpoint to spec → regenerate → done  

## Regenerating

When the OpenAPI spec changes, run:

```bash
# From project root - generates everything
bun scripts/js/gen-api.ts

# Or just TypeScript client
cd viz
pnpm run gen:api
```

This regenerates:
- `internal/dto/types.gen.go` (Go backend types)
- `viz/src/lib/api/client.gen.ts` (TypeScript client with types & functions)
- `viz/src/lib/api/types/api.gen.ts` (TypeScript types)
- `viz/src/lib/api/functions.gen.ts` (TypeScript API functions)

## Adding New Functions

**Option 1: Use Auto-generation (Recommended)**

1. Add the endpoint to `api/openapi/openapi.yaml` with an `operationId`
2. Run `bun scripts/js/gen-api.ts`
3. The function is automatically available!

**Option 2: Use apiClient Directly**

No code generation needed - just use the client:

```typescript
import { apiClient } from "$lib/api";

// Automatically type-safe for any route in OpenAPI spec
const { data, error } = await apiClient.POST("/new-endpoint", {
  body: { foo: "bar" }
});
```

**Option 3: Write Custom Wrappers**

Create a separate `functions.custom.ts` file for hand-crafted functions with complex logic:

```typescript
// functions.custom.ts
import { apiClient } from "./client";

export async function complexOperation(params: { id: string }) {
  // Multiple API calls or complex logic
  const { data: item } = await apiClient.GET("/items/{id}", {
    params: { path: { id: params.id } }
  });
  
  const { data: related } = await apiClient.GET("/items/{id}/related", {
    params: { path: { id: params.id } }
  });
  
  return { item, related };
}
```

Then export it in `index.ts`:
```typescript
export * from "./functions.custom";
```

Example:

```typescript
export async function deleteCollection(uid: string, customFetch?: typeof fetch) {
  const client = customFetch ? createAPIClient(customFetch) : apiClient;
  
  return client.DELETE("/collections/{uid}", {
    params: { path: { uid } }
  });
}
```

## Response Format

All functions return `{ data, error, response }`:

```typescript
const { data, error, response } = await getCollection("abc123");

if (error) {
  console.error("API error:", error);
  return;
}

// data is fully typed based on OpenAPI schema
console.log(data.name, data.description);
```
