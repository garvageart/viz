@use "sass:color";
@use "sass:string";

@function str-replace($string, $search, $replace: "") {
    $index: string.index($string, $search);
    @if $index {
        @return string.slice($string, 1, $index - 1) + $replace +
            str-replace(string.slice($string, $index + string.length($search)), $search, $replace);
    }
    @return $string;
}

@function color-to-svg-hex($color) {
    // Convert color to string (e.g., #ffffff) and replace # with %23
    $str: string.unquote("#{$color}");
    @return str-replace($str, "#", "%23");
}

@mixin scrollbar-arrows($color) {
    $c: color-to-svg-hex($color);

    /* Up */
    ::-webkit-scrollbar-button:single-button:vertical:decrement {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 70 L50 20 L80 70 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }
    ::-webkit-scrollbar-button:single-button:vertical:decrement:hover {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 70 L50 20 L80 70 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }
    ::-webkit-scrollbar-button:single-button:vertical:decrement:active {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 70 L50 20 L80 70 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }

    /* Down */
    ::-webkit-scrollbar-button:single-button:vertical:increment {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 30 L50 80 L80 30 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }
    ::-webkit-scrollbar-button:single-button:vertical:increment:hover {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 30 L50 80 L80 30 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }
    ::-webkit-scrollbar-button:single-button:vertical:increment:active {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='#{$c}'><path d='M20 30 L50 80 L80 30 Z' stroke='#{$c}' stroke-width='10' stroke-linejoin='round'/></svg>");
    }
}

/// Generates the --viz-XX color palette (5% to 100% steps).
///
/// @param {Color} $bg-color - The theme's background color.
/// @param {Color} $text-color - The theme's text color.
/// @param {Color} $base-color - The color used for the step mixing (e.g., blue for light theme, dark blue for dark theme).
/// @param {boolean} $is-light-theme [false] - If true, 100% is the lightest mix; if false, 100% is the darkest/base.
@mixin generate-viz-colors(
    $bg-color,
    $text-color,
    $base-color,
    $is-light-theme: false,
    $flip-bg-color: null,
    $flip-bg-pct: 0%,
    $flip-text-color: null,
    $flip-text-pct: 0%,
    $suffix: ""
) {
    $bg: $bg-color;
    $base: $base-color;
    $text: $text-color;

    // If flip colors are provided, tint the originals by the flip percentage.
    // We pass the flip color as the FIRST argument so `$flip-*-pct` represents
    // how much of the flip color to include.
    @if $flip-bg-color != null {
        $bg: color.mix($flip-bg-color, $bg, $flip-bg-pct);
        $base: color.mix($flip-bg-color, $base, $flip-bg-pct);
    }

    @if $flip-text-color != null {
        $text: color.mix($flip-text-color, $text, $flip-text-pct);
    }

    @if $is-light-theme {
        $bg: color.change($bg, $lightness: 100% - color.channel($bg, "lightness", $space: hsl), $space: hsl);
        $base: color.change($base, $lightness: 100% - color.channel($base, "lightness", $space: hsl), $space: hsl);
        $text: color.change($text, $lightness: 100% - color.channel($text, "lightness", $space: hsl), $space: hsl);
    }

    --viz-bg-color#{$suffix}: #{$bg};
    --viz-text-color#{$suffix}: #{$text};

    // Apply scrollbar arrows using the calculated text color
    @include scrollbar-arrows($text);

    @for $j from 0 through 19 {
        $level: 100 - $j * 5;
        $mixPct: $j * 5%;

        @if $is-light-theme {
            // Light theme: viz-100 is the (lightness-inverted) base; lower
            // levels should be progressively darker by mixing with black.
            --viz-#{$level}#{$suffix}: #{color.mix(black, $base, $mixPct)};
        } @else {
            // Dark theme: viz-100 is the provided base; lower levels should
            // be progressively lighter by mixing with white.
            --viz-#{$level}#{$suffix}: #{color.mix(white, $base, $mixPct)};
        }
    }
}

@mixin viz-theme($sel, $is-light, $flip-bg: null, $flip-bg-pct: 0%, $flip-text: null, $flip-text-pct: 0%) {
    #{$sel} {
        @include generate-viz-colors(
            $bg-color: $bg-color,
            $text-color: $text-color,
            $base-color: $base-color,
            $is-light-theme: $is-light,
            $flip-bg-color: $flip-bg,
            $flip-bg-pct: $flip-bg-pct,
            $flip-text-color: $flip-text,
            $flip-text-pct: $flip-text-pct
        );
    }
}
