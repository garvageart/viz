# install required system packages once
# overriding the packages image
ARG PACKAGES_IMAGE=debian:bookworm-slim
FROM ${PACKAGES_IMAGE} AS packages
# TODO: needs to be configurable/automated
ENV VIPS_VERSION=8.17.2

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential pkg-config git ca-certificates curl \
    meson ninja-build python3 python3-pip python3-setuptools \
    libglib2.0-dev libexpat1-dev libjpeg-dev libpng-dev libtiff-dev \
    libwebp-dev libheif-dev libopenexr-dev liborc-0.4-dev libgirepository1.0-dev \
    libxml2-dev libexif-dev libpoppler-glib-dev libgsf-1-dev libopenjp2-7-dev && \
    rm -rf /var/lib/apt/lists/*

RUN set -eux; \
    apt-get update; \
    mkdir -p /tmp/build && cd /tmp/build; \
    curl -fsSL "https://github.com/libvips/libvips/releases/download/v${VIPS_VERSION}/vips-${VIPS_VERSION}.tar.xz" -o vips.tar.xz; \
    tar xf vips.tar.xz; \
    cd vips-${VIPS_VERSION}; \
    meson setup build --prefix=/usr ; \
    ninja -C build; \
    ninja -C build install; \
    rm -rf /tmp/build; \
    ldconfig || true


# --- Frontend Builder ---
FROM node:24.13.0-bookworm-slim AS frontend-builder
WORKDIR /app/viz
ENV NODE_ENV=production

# Install pnpm
RUN npm install -g pnpm@latest

# Copy frontend dependency definitions
COPY viz/package.json viz/pnpm-lock.yaml viz/.npmrc ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy frontend source
COPY viz/ ./

# Build frontend
# Note: svelte.config.js is configured to output to ../build/viz
# So we expect the output at /app/build/viz
RUN pnpm run generate:icons && pnpm run build


# --- Backend Builder ---
FROM golang:1.25-bookworm AS backend-builder
WORKDIR /src

# reuses apt installed packages from earlier
COPY --from=packages /usr /usr
COPY --from=packages /etc/ssl/certs /etc/ssl/certs

# workspace definition and module files first for caching
COPY go.work go.work.sum ./
COPY go.mod go.sum ./
COPY cmd/api/go.mod cmd/api/go.sum ./cmd/api/

ARG GOPROXY=https://proxy.golang.org,direct
ENV GOPROXY=${GOPROXY}
RUN --mount=type=cache,id=go-mods,target=/go/pkg/mod \
    --mount=type=cache,id=go-build,target=/root/.cache/go-build \
    go env -w GOPROXY=${GOPROXY} && \
    go mod download

COPY . .

ENV CGO_ENABLED=1
RUN mkdir -p /app/build/api
# Use the same cache mounts when building so module compilation is cached between builds
RUN --mount=type=cache,id=go-mods,target=/go/pkg/mod \
    --mount=type=cache,id=go-build,target=/root/.cache/go-build \
    if [ -f Makefile ]; then \
    echo "Building via Makefile (build-api)..."; \
    # Ensure the Makefile uses the same cache locations as BuildKit mounts so
    # Go module downloads are stored in /go/pkg/mod and the Go build cache
    # is stored in /root/.cache/go-build (these are mounted as BuildKit caches
    # above). Override the Makefile cache dir vars when invoking make.
    GO_MOD_CACHE_DIR=/go/pkg/mod GO_BUILD_CACHE_DIR=/root/.cache/go-build make build-api; \
    # Support both legacy output 'build/viz' and Makefile's 'build/api'
    if [ -f build/api ]; then mv build/api /app/build/api/viz; elif [ -f build/viz ]; then mv build/viz /app/build/api/viz; else echo "Expected built binary not found"; exit 1; fi; \
    else \
    go build -o /app/build/api/viz ./cmd/api; \
    fi


# --- Final Runtime ---
FROM debian:bookworm-slim AS runtime
WORKDIR /app

# and again
COPY --from=packages /usr /usr
COPY --from=packages /etc/ssl/certs /etc/ssl/certs

# Create a non-root user
RUN groupadd -r viz && useradd -r -g viz viz && \
    mkdir -p /app/var && chown -R viz:viz /app

# Copy backend binary
COPY --from=backend-builder /app/build/api/viz /app/viz

# Copy frontend assets
# frontend-builder built to /app/build/viz (relative to /app/viz via ../build/viz)
COPY --from=frontend-builder /app/build/viz /app/frontend

COPY viz.json /app/viz.json
COPY version.txt /app/version.txt

# Configure to serve frontend
ENV ENV=production
ENV IMAGINE_FRONTEND_BUILD_PATH=/app/frontend

USER viz

EXPOSE 7770
CMD ["/app/viz"]
